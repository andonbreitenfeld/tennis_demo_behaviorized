<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Sequence name="RootSequence">
      <SubTree ID="StartupSequence"/>
      <!-- <AngleGripper/> -->
      <SubTree ID="PickBallSubtree" ball_pose="{ball_pose}"/>
      <SubTree ID="DropBallSubtree" bin_nav_pose="{bin_nav_pose}"/>
      <!-- <NavigateToPose
          target_pose="{bin_nav_pose}"
          robot_nav_namespace="{nav_namespace}"/> -->
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="StartupSequence">
    <Sequence name="StartupRootSequence">

      <!-- Robot Initialization -->
      <Sequence name="RobotBootSequence">
        <TriggerService service_name="/spot_driver/claim"   timeout="5.0"/>
        <TriggerService service_name="/spot_driver/power_on" timeout="10.0"/>
        <TriggerService service_name="/spot_driver/undock"   timeout="10.0"/>
      </Sequence>


    </Sequence>
  </BehaviorTree>

  <!-- Subtree to pick up ball -->
	<BehaviorTree ID="PickBallSubtree" ball_pose="{ball_pose}">
		<Sequence>
			<!-- Port variables -->
			<Script code="service_timeout:=15"/>
      <!-- manually testing ball pose -->
      <!-- <Script code="ball_pose:={ x:=1.0, y:=2.0, z:=0.3, qx:=0, qy:=0, qz:=0, qw:=1 }"/> -->


      <!-- Mini undock -->
      <TriggerService service_name="/spot_manipulation_driver/mini_unstow_arm"  timeout="{service_timeout}"/>

			<!-- Ensure gripper is open -->
			<TriggerService service_name="/spot_manipulation_driver/open_gripper"  timeout="{service_timeout}"/>

      <!-- Custom MoveIt node (move to ball and rotate arm) -->
      <PickBall ball_pose="{ball_pose}"/>

	    <!-- Close the gripper, grabbing ball -->
			<TriggerService service_name="/spot_manipulation_driver/close_gripper"  timeout="{service_timeout}"/>

			<!-- Stow arm after grabbing ball-->
			<TriggerService service_name="/spot_manipulation_driver/stow_arm" timeout="{service_timeout}"/>
		
		</Sequence>
	</BehaviorTree>

  <!-- Subtree to drop ball in bin -->
	<BehaviorTree ID="DropBallSubtree" bin_nav_pose="{bin_nav_pose}">
		<Sequence>
			<!-- Port variables -->
			<Script code="service_timeout:=15"/>
      <!-- manually testing bin pose -->
      <!-- <Script code="bin_nav_pose:={ x:=1.63907, y:=-0.464794, z:=0.8, qx:=0, qy:=0, qz:=-0.701875, qw:=0.7123}"/> -->

      <!-- Mini unstow -->
      <TriggerService service_name="/spot_manipulation_driver/mini_unstow_arm"  timeout="{service_timeout}"/>

      <!-- Custom MoveIt node (move to ball and rotate arm) -->
      <DropBall bin_nav_pose="{bin_nav_pose}"/>

      <!-- Open gripper to drop ball -->
			<TriggerService service_name="/spot_manipulation_driver/open_gripper"  timeout="{service_timeout}"/>

	    <!-- Close the gripper after dropping -->
			<TriggerService service_name="/spot_manipulation_driver/close_gripper"  timeout="{service_timeout}"/>

			<!-- Stow arm after dropping -->
			<!-- <TriggerService service_name="/spot_manipulation_driver/stow_arm" timeout="{service_timeout}"/> -->
		
		</Sequence>
	</BehaviorTree>

</root>