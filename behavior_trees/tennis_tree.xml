<root BTCPP_format="4" main_tree_to_execute="MainTree">

  <BehaviorTree ID="MainTree">
    <Sequence name="RootSequence">

      <SubTree ID="StartupSequence" poseA="{poseA}" bin_nav_pose="{bin_nav_pose}"/>

      <Script code="@ball_detected := false"/>

      <Parallel name="MonitorAndAct">
        <Repeat num_cycles="-1">
          <IfThenElse>

            <GetMessageFromTopic
                topic="/ball_stable_pose"
                geometry_msgs::msg::PoseStamped="{ball_pose}"
                transient_local="false"
                timeout="1.0"/>

            <Script code="@ball_detected := true"/>
            <Script code="@ball_detected := false"/>

          </IfThenElse>
        </Repeat>

        <!-- Choose fetch or patrol -->
        <Repeat num_cycles="-1">
          <ReactiveFallback name="FetchOrPatrol">

            <Sequence name="FetchIfDetected">
              <ScriptCondition code="@ball_detected == true"/>
              <SubTree ID="FetchBall" ball_pose="{ball_pose}" bin_nav_pose="{bin_nav_pose}"/>
            </Sequence>

            <SubTree ID="Patrol" poseB="{poseB}" poseC="{poseC}"/>

          </ReactiveFallback>
        </Repeat>

      </Parallel>

    </Sequence>
  </BehaviorTree>



  <!-- Initialize Robot & Bin -->
  <BehaviorTree ID="StartupSequence">
    <Sequence name="StartupRootSequence">

      <!-- Robot Initialization -->
      <Sequence name="RobotBootSequence">
        <TriggerService service_name="/spot_driver/claim"    timeout="10.0"/>
        <TriggerService service_name="/spot_driver/power_on" timeout="10.0"/>
        <TriggerService service_name="/spot_driver/undock"   timeout="10.0"/>
        <TriggerService service_name="/spot_manipulation_driver/open_gripper"   timeout="10.0"/>
      </Sequence>

      <!-- Help Apriltag Localization -->
      <Delay delay_msec="2000">
        <AlwaysSuccess/>
      </Delay>

      <SubTree ID="WalkToGoal" goal_pose="{poseA}"/>

      <!-- Find Bin TF & Compute Nav2 Goal -->
      <RetryUntilSuccessful num_attempts="-1">
        <Sequence name="InitializeBin">

          <LookupTF ref_frame="spot_nav/map"
                    target_frame="bin_tag_link"
                    pose="{bin_tag_pose}"
                    timeout_secs="1.0"/>

          <ComputeBinApproachGoal 
              tag_pose="{bin_tag_pose}"
              standoff="1.3"
              bin_nav_pose="{bin_nav_pose}"/>

        </Sequence>
      </RetryUntilSuccessful>

    </Sequence>
  </BehaviorTree>



  <!-- Patrol between Waypoints -->
  <BehaviorTree ID="Patrol">
    <Sequence name="PatrolSequence">
      
      <SubTree ID="WalkToGoal" goal_pose="{poseB}"/>
      <SubTree ID="Spin"/>

      <SubTree ID="WalkToGoal" goal_pose="{poseC}"/>
      <SubTree ID="Spin"/>

    </Sequence>
  </BehaviorTree>



  <!-- Fetch Ball -->
  <!-- NOTE: ball_nav_pose port removed here; it's internal to this tree -->
  <BehaviorTree ID="FetchBall" bin_nav_pose="{bin_nav_pose}">
    <Sequence name="FetchBallSequence">

      <ComputeBallApproachGoal
          nav_frame="spot_nav/map"
          robot_frame="base_link"
          standoff="1.3"
          ball_pose="{ball_pose}"
          ball_nav_pose="{ball_nav_pose}"/>

      <!-- Walk to ball -->
      <SubTree ID="WalkToGoal" goal_pose="{ball_nav_pose}"/>

      <!-- PLACEHOLDER: Insert grasp here -->
      <Delay delay_msec="1000">
        <AlwaysSuccess/>
      </Delay>

      <!-- Nav2 to bin -->
      <RetryUntilSuccessful num_attempts="-1">
        <NavigateToPose
            robot_nav_namespace="spot_nav"
            target_pose="{bin_nav_pose}"/>
      </RetryUntilSuccessful>

      <!-- PLACEHOLDER: Insert drop here -->
      <Delay delay_msec="5000">
        <AlwaysSuccess/>
      </Delay>

    </Sequence>
  </BehaviorTree>



  <!-- Spin in Place -->
  <BehaviorTree ID="Spin">
    <Sequence name="SpinSequence">

      <GetCurrentPose
          reference_frame="spot_nav/map"
          target_frame="base_footprint"
          static="false"
          pose="{spin_pose}"/>
      
      <Delay delay_msec="5000">
        <AlwaysSuccess/>
      </Delay>

      <Repeat num_cycles="3">
        <Sequence name="SpinStep">

          <RotatePoseYaw
              in_pose="{spin_pose}"
              delta_deg="90.0"
              out_pose="{spin_pose}"/>

          <SubTree ID="WalkToGoal" goal_pose="{spin_pose}"/>

          <Delay delay_msec="5000">
            <AlwaysSuccess/>
          </Delay>

        </Sequence>
      </Repeat>

    </Sequence>
  </BehaviorTree>



  <!-- Wrapper for WalkToPose -->
  <BehaviorTree ID="WalkToGoal" goal_pose="{goal_pose}">
    <Sequence name="WalkToGoalSequence">

      <!-- Port variables -->
      <Script code="retry_count := -1"/>
      <Script code="trans_err_threshold := 0.6"/>
      <Script code="rot_err_threshold := 0.07"/>

      <!-- Attempt to go to goal with retries -->
      <RetryUntilSuccessful num_attempts="{retry_count}">
        <WalkToPose
            target_pose="{goal_pose}"
            trans_err_threshold="{trans_err_threshold}"
            rot_err_threshold="{rot_err_threshold}"/>
      </RetryUntilSuccessful>

    </Sequence>
  </BehaviorTree>

</root>