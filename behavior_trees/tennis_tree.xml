<root BTCPP_format="4" main_tree_to_execute="MainTree">
  
  <BehaviorTree ID="MainTree">
    <Sequence name="RootSequence">
      
      <!-- Startup: Claim lease, Power on, Undock -->
      <Sequence name="StartupSequence">
        <TriggerService service_name="/spot_driver/claim" timeout="5.0"/>
        <TriggerService service_name="/spot_driver/power_on" timeout="10.0"/>
        <TriggerService service_name="/spot_driver/undock" timeout="10.0"/>
      </Sequence>

      <!-- Wait for bin detection (blocks until bin is detected) -->
      <RetryUntilSuccessful num_attempts="-1">
        <CheckBinDetected/>
      </RetryUntilSuccessful>

      <!-- Navigate to survey location (pose set in blackboard from C++ code) -->
      <NavigateToPose target_pose="{survey_pose}" robot_nav_namespace="spot_nav"/>

      <!-- Main loop: Wait for ball, go to ball, go to bin, return to survey, repeat -->
      <ForceSuccess>
        <Repeat num_cycles="-1">
          <Sequence name="BallCollectionCycle">
            
            <!-- Wait for ball detection -->
            <RetryUntilSuccessful num_attempts="-1">
              <CheckBallDetected/>
            </RetryUntilSuccessful>

            <!-- Get ball pose and navigate to it (uninterruptible sequence) -->
            <Sequence name="GoToBallUninterruptible">
              <GetBallPose ball_pose="{ball_pose}"/>
              <NavigateToPose target_pose="{ball_pose}" robot_nav_namespace="spot_nav"/>
              <Delay delay_msec="3000">
                <AlwaysSuccess/>
              </Delay>
            </Sequence>

            <!-- Pick ball, call subtree -->
            <Sequence name="PickBall">
              <GetBallPose ball_pose="{ball_pose}"/>
              <NavigateToPose target_pose="{ball_pose}" robot_nav_namespace="spot_nav"/>
              <Delay delay_msec="3000">
                <AlwaysSuccess/>
              </Delay>
            </Sequence>

            <!-- Get bin pose and navigate to it (uninterruptible sequence) -->
            <Sequence name="GoToBinUninterruptible">
              <GetBinPose bin_pose="{bin_pose}"/>
              <NavigateToPose target_pose="{bin_pose}" robot_nav_namespace="spot_nav"/>
              <Delay delay_msec="3000">
                <AlwaysSuccess/>
              </Delay>
            </Sequence>

            <!-- Drop ball, call subtree -->

            <!-- Return to survey point -->
            <NavigateToPose target_pose="{survey_pose}" robot_nav_namespace="spot_nav"/>

          </Sequence>
        </Repeat>
      </ForceSuccess>

    </Sequence>
  </BehaviorTree>

  <!-- Subtree to retract arm -->
	<BehaviorTree ID="PickBall">
		<Sequence>
			<!-- Port variables -->
			<Script code="service_timeout:=15"/>
			<Script code="open_gripper_service:= '/spot_manipulation_driver/open_gripper'"/>
			<Script code="close_gripper_service:= '/spot_manipulation_driver/close_gripper'"/>
			<Script code="stow_service:='/spot_manipulation_driver/stow_arm'"/>
      <Script code="unstow_gripper_service:= '/spot_manipulation_driver/mini_unstow_arm'"/>

			<!-- <Script code="postaffordance_downward:=POSTAFFORDANCE_DOWNWARD"/> -->
			<!-- <Script code="retract:=RETRACT"/> -->

      <!-- Mini undock -->

			<!-- Ensure gripper is open -->
			<TriggerService service_name="{open_gripper_service}"  timeout="{service_timeout}"/>

      <!-- Custom MoveIt node (move to ball and rotate arm) -->


	    <!-- Close the gripper, grabbing ball -->
			<TriggerService service_name="{close_gripper_service}"  timeout="{service_timeout}"/>

			<!-- Stow arm after grabbing ball-->
			<TriggerService service_name="{stow_service}" timeout="{service_timeout}"/>
			<GetStowState is_stowed="{is_stowed}" timeout_secs='3.0'/>
			<BooleanCondition value="{is_stowed}"/>

		
		</Sequence>
	</BehaviorTree>

</root>