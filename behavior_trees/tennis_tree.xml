<root BTCPP_format="4" main_tree_to_execute="MainTree">

  <BehaviorTree ID="MainTree">
    <Sequence name="RootSequence">

      <SubTree ID="StartupSequence" bin_nav_pose="{bin_nav_pose}"/>

      <Repeat num_cycles="-1">
        <ReactiveFallback name="FetchOrPatrol">
          <SubTree ID="FetchBall"/>
          <SubTree ID="Patrol" poseA="{poseA}" poseB="{poseB}"/>
        </ReactiveFallback>
      </Repeat>

    </Sequence>
  </BehaviorTree>



  <!-- Initialize Robot & Bin -->
  <BehaviorTree ID="StartupSequence">
    <Sequence name="StartupRootSequence">

      <!-- Robot Initialization -->
      <Sequence name="RobotBootSequence">
        <TriggerService service_name="/spot_driver/claim"    timeout="5.0"/>
        <TriggerService service_name="/spot_driver/power_on" timeout="10.0"/>
        <TriggerService service_name="/spot_driver/undock"   timeout="10.0"/>
      </Sequence>

      <!-- Find Bin TF & Compute Nav2 Goal -->
      <RetryUntilSuccessful num_attempts="-1">
        <Sequence name="InitializeBin">

          <LookupTF ref_frame="spot_nav/map"
                    target_frame="bin_tag_link"
                    pose="{bin_tag_pose}"
                    timeout_secs="1.0"/>

          <ComputeBinApproachGoal 
              tag_pose="{bin_tag_pose}"
              standoff="1.3"
              bin_nav_pose="{bin_nav_pose}"/>

        </Sequence>
      </RetryUntilSuccessful>

    </Sequence>
  </BehaviorTree>



  <!-- Patrol between Waypoints -->
  <BehaviorTree ID="Patrol">
    <Sequence name="PatrolSequence">

      <NavigateToPose
          robot_nav_namespace="spot_nav"
          target_pose="{poseA}"/>
      <Delay delay_msec="5000">
        <AlwaysSuccess name="WaitAfterA"/>
      </Delay>

      <NavigateToPose
          robot_nav_namespace="spot_nav"
          target_pose="{poseB}"/>
      <Delay delay_msec="10000">
        <AlwaysSuccess name="WaitAfterB"/>
      </Delay>

    </Sequence>
  </BehaviorTree>



  <!-- Fetch Ball -->
  <BehaviorTree ID="FetchBall">
    <Sequence name="FetchBallSequence">

      <!-- Get stable ball pose -->
      <GetMessageFromTopic
          topic="/ball_stable_pose"
          geometry_msgs::msg::PoseStamped="{ball_pose}"
          transient_local="false"
          timeout="3.0"/>

      <!-- Compute Nav2 Goal -->
      <ComputeBallApproachGoal
          nav_frame="spot_nav/map"
          robot_frame="base_link"
          standoff="1.3"
          ball_pose="{ball_pose}"
          ball_nav_pose="{ball_nav_pose}"/>

      <!-- Navigate to ball -->
      <NavigateToPose
          robot_nav_namespace="spot_nav"
          target_pose="{ball_nav_pose}"/>

    </Sequence>
  </BehaviorTree>

</root>
