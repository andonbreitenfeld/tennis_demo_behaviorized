<root BTCPP_format="4" main_tree_to_execute="MainTree">

  <BehaviorTree ID="MainTree">
    <Sequence name="RootSequence">

      <SubTree ID="StartupSequence" poseA="{poseA}" bin_nav_pose="{bin_nav_pose}"/>

      <Script code="@ball_detected := false"/>

      <Parallel name="MonitorAndAct">
        <Repeat num_cycles="-1">
          <IfThenElse>

            <GetMessageFromTopic
                topic="/ball_stable_pose"
                geometry_msgs::msg::PoseStamped="{ball_pose}"
                transient_local="false"
                timeout="1.0"/>

            <Script code="@ball_detected := true"/>
            <Script code="@ball_detected := false"/>

          </IfThenElse>
        </Repeat>

        <!-- Choose fetch or patrol -->
        <Repeat num_cycles="-1">
          <ReactiveFallback name="FetchOrPatrol">

            <Sequence name="FetchIfDetected">
              <ScriptCondition code="@ball_detected == true"/>
              <SubTree ID="FetchBall" ball_pose="{ball_pose}" bin_nav_pose="{bin_nav_pose}"/>
            </Sequence>

            <SubTree ID="Patrol" poseB="{poseB}" poseC="{poseC}"/>

          </ReactiveFallback>
        </Repeat>

      </Parallel>

    </Sequence>
  </BehaviorTree>



  <!-- Initialize Robot & Bin -->
  <BehaviorTree ID="StartupSequence">
    <Sequence name="StartupRootSequence">

      <!-- Robot Initialization -->
      <Sequence name="RobotBootSequence">
        <TriggerService service_name="/spot_driver/claim"    timeout="10.0"/>
        <TriggerService service_name="/spot_driver/power_on" timeout="10.0"/>
        <TriggerService service_name="/spot_driver/undock"   timeout="10.0"/>
        <TriggerService service_name="/spot_manipulation_driver/open_gripper" timeout="10.0"/>
      </Sequence>

      <!-- Walk to initial goal pose -->
      <SubTree ID="WalkToGoal"
              goal_pose="{poseA}"
              trans_err_threshold="0.3"
              rot_err_threshold="0.1"/>

      <!-- Find bin until we succeed -->
      <RetryUntilSuccessful num_attempts="-1">
        <Sequence name="FindBin">

          <Delay delay_msec="15000">
            <AlwaysSuccess/>
          </Delay>

          <LookupTF
              ref_frame="spot_nav/map"
              target_frame="bin_tag_link"
              pose="{bin_tag_pose}"
              timeout_secs="0.1"/>

          <ComputeBinApproachGoal
              tag_pose="{bin_tag_pose}"
              standoff="1.6"
              bin_nav_pose="{bin_nav_pose}"
              bin_frame_id="bin_nav_goal"/>

        </Sequence>
      </RetryUntilSuccessful>

    </Sequence>
  </BehaviorTree>



  <!-- Patrol between Waypoints -->
  <BehaviorTree ID="Patrol">
    <Sequence name="PatrolSequence">
      
      <SubTree ID="WalkToGoal"
               goal_pose="{poseB}"
               trans_err_threshold="0.5"
               rot_err_threshold="0.2"/>
      <SubTree ID="Spin" delay_msec="7000"/>

      <SubTree ID="WalkToGoal"
               goal_pose="{poseC}"
               trans_err_threshold="0.5"
               rot_err_threshold="0.2"/>
      <SubTree ID="Spin" delay_msec="7000"/>

    </Sequence>
  </BehaviorTree>



  <!-- Fetch Ball -->
  <BehaviorTree ID="FetchBall" ball_pose="{ball_pose}" bin_nav_pose="{bin_nav_pose}">
    <Sequence name="FetchBallSequence">

      <ComputeBallApproachGoal
          nav_frame="spot_nav/map"
          robot_frame="base_link"
          standoff="0.8"
          ball_pose="{ball_pose}"
          ball_nav_pose="{ball_nav_pose}"/>

      <!-- Walk to ball -->
      <SubTree ID="WalkToGoal"
               goal_pose="{ball_nav_pose}"
               trans_err_threshold="0.05"
               rot_err_threshold="0.05"/>

      <!-- Pick up ball -->
      <SubTree ID="PickBallSubtree" ball_pose="{ball_pose}"/>

      <!-- Navigate to bin -->
      <SubTree ID="WalkToGoal"
               goal_pose="{bin_nav_pose}"
               trans_err_threshold="0.05"
               rot_err_threshold="0.05"/>

      <!-- Drop ball in bin -->
      <SubTree ID="DropBallSubtree" bin_nav_pose="{bin_nav_pose}"/>

    </Sequence>
  </BehaviorTree>



  <!-- Subtree to pick up ball -->
  <BehaviorTree ID="PickBallSubtree" ball_pose="{ball_pose}">
    <Sequence>
      <!-- Port variables -->
      <Script code="service_timeout:=15"/>

      <!-- Mini unstow -->
      <TriggerService service_name="/spot_manipulation_driver/mini_unstow_arm" timeout="{service_timeout}"/>

      <!-- Ensure gripper is open -->
      <TriggerService service_name="/spot_manipulation_driver/open_gripper" timeout="{service_timeout}"/>

      <!-- Custom MoveIt node (move to ball and rotate arm) -->
      <PickBall ball_pose="{ball_pose}"/>

      <!-- Close the gripper, grabbing ball -->
      <TriggerService service_name="/spot_manipulation_driver/close_gripper" timeout="{service_timeout}"/>

      <!-- Stow arm after grabbing ball -->
      <TriggerService service_name="/spot_manipulation_driver/stow_arm" timeout="{service_timeout}"/>

    </Sequence>
  </BehaviorTree>



  <!-- Subtree to drop ball in bin -->
  <BehaviorTree ID="DropBallSubtree" bin_nav_pose="{bin_nav_pose}">
    <Sequence>
      <!-- Port variables -->
      <Script code="service_timeout:=15"/>

      <!-- Mini unstow -->
      <TriggerService service_name="/spot_manipulation_driver/mini_unstow_arm" timeout="{service_timeout}"/>

      <!-- Custom MoveIt node (move to bin and position arm) -->
      <DropBall bin_nav_pose="{bin_nav_pose}"/>

      <!-- Open gripper to drop ball -->
      <TriggerService service_name="/spot_manipulation_driver/open_gripper" timeout="{service_timeout}"/>

      <!-- Close the gripper after dropping -->
      <TriggerService service_name="/spot_manipulation_driver/close_gripper" timeout="{service_timeout}"/>

      <!-- Stow arm after dropping -->
      <TriggerService service_name="/spot_manipulation_driver/stow_arm" timeout="{service_timeout}"/>

    </Sequence>
  </BehaviorTree>



  <!-- Spin in Place -->
  <BehaviorTree ID="Spin" delay_msec="{delay_msec}">
    <Sequence name="SpinSequence">

      <GetCurrentPose
          reference_frame="spot_nav/map"
          target_frame="base_footprint"
          static="false"
          pose="{spin_pose}"/>
      
      <Delay delay_msec="{delay_msec}">
        <AlwaysSuccess/>
      </Delay>

      <Repeat num_cycles="3">
        <Sequence name="SpinStep">

          <RotatePoseYaw
              in_pose="{spin_pose}"
              delta_deg="90.0"
              out_pose="{spin_pose}"/>

          <SubTree ID="WalkToGoal"
                   goal_pose="{spin_pose}"
                   trans_err_threshold="0.5"
                   rot_err_threshold="0.2"/>

          <Delay delay_msec="{delay_msec}">
            <AlwaysSuccess/>
          </Delay>

        </Sequence>
      </Repeat>

    </Sequence>
  </BehaviorTree>



  <!-- Wrapper for WalkToPose -->
  <BehaviorTree ID="WalkToGoal"
                goal_pose="{goal_pose}"
                trans_err_threshold="{trans_err_threshold}"
                rot_err_threshold="{rot_err_threshold}">
    <Sequence name="WalkToGoalSequence">

      <Script code="retry_count := -1"/>

      <RetryUntilSuccessful num_attempts="{retry_count}">
        <WalkToPose
            target_pose="{goal_pose}"
            trans_err_threshold="{trans_err_threshold}"
            rot_err_threshold="{rot_err_threshold}"/>
      </RetryUntilSuccessful>

    </Sequence>
  </BehaviorTree>

</root>